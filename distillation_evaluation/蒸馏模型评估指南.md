# è’¸é¦æ¨¡å‹è¯„ä¼°æŒ‡å—

åŸºäºChinese-CLIPå®˜æ–¹è¯„ä¼°æµç¨‹çš„å®Œæ•´è¯„ä¼°æ–¹æ¡ˆ

## ğŸ“‹ è¯„ä¼°æµç¨‹æ¦‚è¿°

æ ¹æ®Chinese-CLIPæ–‡æ¡£ï¼Œå®Œæ•´çš„è¯„ä¼°æµç¨‹åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

1. **å›¾æ–‡ç‰¹å¾æå–** - ä½¿ç”¨è’¸é¦æ¨¡å‹æå–å›¾åƒå’Œæ–‡æœ¬çš„ç‰¹å¾å‘é‡
2. **KNNæ£€ç´¢** - åŸºäºç‰¹å¾å‘é‡è¿›è¡Œæœ€è¿‘é‚»æ£€ç´¢
3. **Recallè®¡ç®—** - è®¡ç®—æ£€ç´¢ä»»åŠ¡çš„Recall@1/5/10æŒ‡æ ‡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. ç¡®ä¿å¯ä»¥é€šè¿‡ `ssh seetacloud-v800` æ— å¯†é’¥ç™»å½•äº‘æœåŠ¡å™¨
2. äº‘æœåŠ¡å™¨ä¸Šå·²å®‰è£…Chinese-CLIPä»£ç åº“åœ¨ `/root/autodl-tmp/Chinese-CLIP`
3. condaç¯å¢ƒ `training` å·²é…ç½®å¥½
4. æ•°æ®é›†å·²æŒ‰Chinese-CLIPæ ¼å¼å‡†å¤‡å¥½

### äº‘æœåŠ¡å™¨ç›®å½•ç»“æ„

å®é™…çš„äº‘æœåŠ¡å™¨ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
/root/autodl-tmp/
â”œâ”€â”€ Chinese-CLIP/                   # Chinese-CLIPä»£ç åº“
â”œâ”€â”€ datapath/                       # æ•°æ®æ ¹ç›®å½•
â”‚   â”œâ”€â”€ datasets/                   # æ•°æ®é›†ç›®å½•
â”‚   â”‚   â””â”€â”€ Flickr30k-CN/          # ç¤ºä¾‹æ•°æ®é›†
â”‚   â”‚       â”œâ”€â”€ lmdb/
â”‚   â”‚       â”‚   â””â”€â”€ valid/
â”‚   â”‚       â”‚       â””â”€â”€ imgs/       # LMDBæ ¼å¼çš„å›¾åƒæ•°æ®
â”‚   â”‚       â”œâ”€â”€ valid_texts.jsonl   # æ–‡æœ¬æ•°æ®
â”‚   â”‚       â”œâ”€â”€ valid_imgs.tsv      # å›¾åƒå…ƒæ•°æ®
â”‚   â”‚       â”œâ”€â”€ train_texts.jsonl   # è®­ç»ƒæ–‡æœ¬æ•°æ®
â”‚   â”‚       â””â”€â”€ test_texts.jsonl    # æµ‹è¯•æ–‡æœ¬æ•°æ®
â”‚   â”œâ”€â”€ experiments/                # è®­ç»ƒå®éªŒç›®å½•
â”‚   â”‚   â”œâ”€â”€ muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/
â”‚   â”‚   â”‚   â””â”€â”€ checkpoints/        # TEAMè’¸é¦æ¨¡å‹
â”‚   â”‚   â”‚       â””â”€â”€ epoch_latest.pt
â”‚   â”‚   â”œâ”€â”€ muge_finetune_vit-b-16_roberta-base_bs512_4gpu_large_distill/
â”‚   â”‚   â”‚   â””â”€â”€ checkpoints/        # Largeè’¸é¦æ¨¡å‹
â”‚   â”‚   â””â”€â”€ muge_finetune_vit-b-16_roberta-base_bs512_4gpu_huge_distill/
â”‚   â”‚       â””â”€â”€ checkpoints/        # Hugeè’¸é¦æ¨¡å‹
â”‚   â””â”€â”€ pretrained_weights/         # é¢„è®­ç»ƒæ¨¡å‹æƒé‡
â””â”€â”€ setup_environment.sh            # ç¯å¢ƒé…ç½®è„šæœ¬
```

### å¯ç”¨è’¸é¦æ¨¡å‹å¯¹æ¯”

| æ¨¡å‹ç±»å‹ | ç›®å½•åç§° | æ¨¡å‹è·¯å¾„ | æè¿° |
|---------|---------|----------|------|
| **TEAMè’¸é¦** | `muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill` | `/root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/epoch_latest.pt` | TEAMæ–¹æ³•è’¸é¦æ¨¡å‹ |
| **Largeè’¸é¦** | `muge_finetune_vit-b-16_roberta-base_bs512_4gpu_large_distill` | `/root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_large_distill/checkpoints/epoch_latest.pt` | Largeæ¨¡å‹è’¸é¦ç‰ˆæœ¬ |
| **Hugeè’¸é¦** | `muge_finetune_vit-b-16_roberta-base_bs512_4gpu_huge_distill` | `/root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_huge_distill/checkpoints/epoch_latest.pt` | Hugeæ¨¡å‹è’¸é¦ç‰ˆæœ¬ |
| **åŸºå‡†æ¨¡å‹** | `muge_finetune_vit-b-16_roberta-base_bs128_1gpu_baseline` | `/root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs128_1gpu_baseline/checkpoints/epoch_latest.pt` | åŸºå‡†å¯¹æ¯”æ¨¡å‹ |

**æ³¨æ„ï¼š** æ‰€æœ‰æ¨¡å‹éƒ½ä½¿ç”¨ç›¸åŒçš„æ¶æ„å‚æ•°ï¼š
- `--vision-model ViT-B-16`
- `--text-model RoBERTa-wwm-ext-base-chinese`

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: å®Œæ•´è¯„ä¼°ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `distillation_model_evaluation.py` è„šæœ¬è¿›è¡Œå®Œæ•´è¯„ä¼°ï¼š

```bash
python distillation_model_evaluation.py \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/epoch_latest.pt \
    --split valid \
    --vision-model ViT-B-16 \
    --text-model RoBERTa-wwm-ext-base-chinese
```

#### å‚æ•°è¯´æ˜ï¼š

- `--datapath`: æ•°æ®æ ¹ç›®å½•è·¯å¾„ï¼ˆäº‘æœåŠ¡å™¨ä¸Šä¸ºï¼š`/root/autodl-tmp/datapath`ï¼‰
- `--dataset-name`: æ•°æ®é›†åç§°ï¼ˆå¦‚ï¼š`Flickr30k-CN`ï¼‰
- `--model-path`: è’¸é¦æ¨¡å‹æ£€æŸ¥ç‚¹è·¯å¾„ï¼ˆä½äºexperimentsç›®å½•ä¸‹ï¼‰
- `--split`: æ•°æ®é›†åˆ†å‰² (valid/test)
- `--vision-model`: è§†è§‰æ¨¡å‹ç±»å‹
- `--text-model`: æ–‡æœ¬æ¨¡å‹ç±»å‹

#### å¯é€‰å‚æ•°ï¼š

- `--skip-extraction`: è·³è¿‡ç‰¹å¾æå–ï¼ˆå¦‚æœå·²æœ‰ç‰¹å¾æ–‡ä»¶ï¼‰
- `--skip-text-to-image`: è·³è¿‡æ–‡åˆ°å›¾æ£€ç´¢
- `--skip-image-to-text`: è·³è¿‡å›¾åˆ°æ–‡æ£€ç´¢

### æ–¹æ³•2: åˆ†æ­¥æ‰§è¡Œ

ä½¿ç”¨ `quick_evaluation.py` è„šæœ¬è¿›è¡Œåˆ†æ­¥æµ‹è¯•ï¼š

#### æ­¥éª¤1: ç‰¹å¾æå–
```bash
python quick_evaluation.py \
    --step extract \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/epoch_latest.pt \
    --split valid
```

#### æ­¥éª¤2: KNNæ£€ç´¢
```bash
python quick_evaluation.py \
    --step knn \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --split valid
```

#### æ­¥éª¤3: Recallè®¡ç®—
```bash
python quick_evaluation.py \
    --step recall \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --split valid
```

## ğŸ“Š ç»“æœè§£è¯»

### è¾“å‡ºæ–‡ä»¶

è¯„ä¼°å®Œæˆåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

1. **ç‰¹å¾æ–‡ä»¶**:
   - `${split}_imgs.img_feat.jsonl`: å›¾åƒç‰¹å¾
   - `${split}_texts.txt_feat.jsonl`: æ–‡æœ¬ç‰¹å¾

2. **æ£€ç´¢ç»“æœ**:
   - `${split}_predictions.jsonl`: æ–‡åˆ°å›¾æ£€ç´¢ç»“æœ
   - `${split}_tr_predictions.jsonl`: å›¾åˆ°æ–‡æ£€ç´¢ç»“æœ

3. **è¯„ä¼°ç»“æœ**:
   - `text_to_image_results.json`: æ–‡åˆ°å›¾æ£€ç´¢çš„RecallæŒ‡æ ‡
   - `image_to_text_results.json`: å›¾åˆ°æ–‡æ£€ç´¢çš„RecallæŒ‡æ ‡

### ç»“æœæ ¼å¼

Recallç»“æœJSONæ ¼å¼ï¼š
```json
{
    "success": true,
    "score": 85.67,
    "scoreJson": {
        "score": 85.67,
        "mean_recall": 85.67,
        "r1": 71.2,    # Recall@1
        "r5": 90.5,    # Recall@5
        "r10": 95.3    # Recall@10
    }
}
```

### å®é™…æµ‹è¯•ç»“æœç¤ºä¾‹

åŸºäºFlickr30k-CNéªŒè¯é›†çš„TEAMè’¸é¦æ¨¡å‹è¯„ä¼°ç»“æœï¼š

```json
{
    "success": true,
    "score": 0.5333333333333333,
    "scoreJson": {
        "score": 0.5333333333333333,
        "mean_recall": 0.5333333333333333,
        "r1": 0.1,      # 10% - Top-1æ£€ç´¢æˆåŠŸç‡
        "r5": 0.5,      # 50% - Top-5æ£€ç´¢æˆåŠŸç‡  
        "r10": 1.0      # 100% - Top-10æ£€ç´¢æˆåŠŸç‡
    }
}
```

**ç»“æœè§£é‡Šï¼š**
- **Mean Recall**: 53.3% - å¹³å‡æ£€ç´¢æˆåŠŸç‡
- **R@1**: 10% - åœ¨å‰1ä¸ªæ£€ç´¢ç»“æœä¸­æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ¯”ä¾‹
- **R@5**: 50% - åœ¨å‰5ä¸ªæ£€ç´¢ç»“æœä¸­æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ¯”ä¾‹
- **R@10**: 100% - åœ¨å‰10ä¸ªæ£€ç´¢ç»“æœä¸­æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ¯”ä¾‹

**ç‰¹å¾æå–ç»Ÿè®¡ï¼š**
- å›¾åƒç‰¹å¾æ•°é‡: 1000ä¸ª (å­˜å‚¨åœ¨ `valid_imgs.img_feat.jsonl`)
- æ–‡æœ¬ç‰¹å¾æ•°é‡: 5000ä¸ª (å­˜å‚¨åœ¨ `valid_texts.txt_feat.jsonl`)
- æ£€ç´¢é¢„æµ‹: 5000æ¡ (å­˜å‚¨åœ¨ `valid_predictions.jsonl`)

## ğŸ¯ ç¤ºä¾‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: è¯„ä¼°TEAMè’¸é¦æ¨¡å‹

```bash
python distillation_model_evaluation.py \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/epoch_latest.pt \
    --split valid \
    --vision-model ViT-B-16 \
    --text-model RoBERTa-wwm-ext-base-chinese
```

### åœºæ™¯2: è¯„ä¼°Largeè’¸é¦æ¨¡å‹

```bash
python distillation_model_evaluation.py \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_large_distill/checkpoints/epoch_latest.pt \
    --split valid \
    --vision-model ViT-B-16 \
    --text-model RoBERTa-wwm-ext-base-chinese
```

### åœºæ™¯3: è¯„ä¼°Hugeè’¸é¦æ¨¡å‹

```bash
python distillation_model_evaluation.py \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_huge_distill/checkpoints/epoch_latest.pt \
    --split valid \
    --vision-model ViT-B-16 \
    --text-model RoBERTa-wwm-ext-base-chinese
```

### åœºæ™¯4: åªæµ‹è¯•ç‰¹å¾æå–æ•ˆæœ

```bash
python quick_evaluation.py \
    --step extract \
    --datapath /root/autodl-tmp/datapath \
    --dataset-name Flickr30k-CN \
    --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/epoch_latest.pt
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **SSHè¿æ¥**: ç¡®ä¿ä½¿ç”¨ `ssh seetacloud-v800` è¿æ¥äº‘æœåŠ¡å™¨
2. **å†…å­˜è¦æ±‚**: ç‰¹å¾æå–éœ€è¦GPUæ˜¾å­˜ï¼Œå»ºè®®å•å¡è¿è¡Œ
3. **å­˜å‚¨ç©ºé—´**: ç‰¹å¾æ–‡ä»¶å¯èƒ½è¾ƒå¤§ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç£ç›˜ç©ºé—´
4. **ç½‘ç»œè¿æ¥**: ç¡®ä¿SSHè¿æ¥ç¨³å®šï¼Œé•¿æ—¶é—´è¯„ä¼°å»ºè®®ä½¿ç”¨screen/tmux
5. **ç¯å¢ƒä¸€è‡´æ€§**: ç¡®ä¿äº‘æœåŠ¡å™¨ç¯å¢ƒä¸è®­ç»ƒç¯å¢ƒä¸€è‡´

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **SSHè¿æ¥å¤±è´¥**:
   ```bash
   # æµ‹è¯•SSHè¿æ¥
   ssh seetacloud-v800 'echo "è¿æ¥æˆåŠŸ"'
   ```

2. **condaç¯å¢ƒé—®é¢˜**:
   ```bash
   # ç¡®è®¤ç¯å¢ƒå­˜åœ¨
   ssh seetacloud-v800 'conda env list'
   # æ¿€æ´»trainingç¯å¢ƒ
   ssh seetacloud-v800 'source /root/miniconda3/etc/profile.d/conda.sh && conda activate training'
   ```

3. **CUDAè®¾å¤‡é—®é¢˜**:
   ```bash
   # æ£€æŸ¥GPUçŠ¶æ€
   ssh seetacloud-v800 'nvidia-smi'
   ```

4. **æ–‡ä»¶è·¯å¾„é—®é¢˜**:
   ```bash
   # æ£€æŸ¥æ•°æ®é›†è·¯å¾„
   ssh seetacloud-v800 'ls -la /root/autodl-tmp/datapath/datasets/'
   # æ£€æŸ¥æ¨¡å‹è·¯å¾„
   ssh seetacloud-v800 'ls -la /root/autodl-tmp/datapath/experiments/'
   ```

5. **æ¨¡å‹æ£€æŸ¥ç‚¹é—®é¢˜**:
   ```bash
   # æ£€æŸ¥TEAMæ¨¡å‹
   ssh seetacloud-v800 'ls -la /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/'
   ```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹å¤„ç†å¤§å°**: æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´batch size
2. **å¹¶è¡Œå¤„ç†**: å¯¹äºå¤§æ•°æ®é›†ï¼Œå¯ä»¥è€ƒè™‘åˆ†æ‰¹å¤„ç†
3. **ç‰¹å¾ç¼“å­˜**: ä¿å­˜ç‰¹å¾æ–‡ä»¶ä»¥é¿å…é‡å¤è®¡ç®—

## ğŸš€ å¿«é€Ÿå‚è€ƒå‘½ä»¤

### ä¸€é”®è¯„ä¼°æ‰€æœ‰è’¸é¦æ¨¡å‹

```bash
# TEAMè’¸é¦æ¨¡å‹
python quick_evaluation.py --step extract --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_team_distill/checkpoints/epoch_latest.pt
python quick_evaluation.py --step knn --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN
python quick_evaluation.py --step recall --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN

# Largeè’¸é¦æ¨¡å‹
python quick_evaluation.py --step extract --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_large_distill/checkpoints/epoch_latest.pt
python quick_evaluation.py --step knn --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN
python quick_evaluation.py --step recall --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN

# Hugeè’¸é¦æ¨¡å‹
python quick_evaluation.py --step extract --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN --model-path /root/autodl-tmp/datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs512_4gpu_huge_distill/checkpoints/epoch_latest.pt
python quick_evaluation.py --step knn --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN
python quick_evaluation.py --step recall --datapath /root/autodl-tmp/datapath --dataset-name Flickr30k-CN
```

### å¸¸ç”¨æ£€æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥SSHè¿æ¥
ssh seetacloud-v800 'echo "è¿æ¥æˆåŠŸ"'

# æ£€æŸ¥GPUçŠ¶æ€
ssh seetacloud-v800 'nvidia-smi'

# æ£€æŸ¥condaç¯å¢ƒ
ssh seetacloud-v800 'conda env list'

# æ£€æŸ¥æ•°æ®é›†
ssh seetacloud-v800 'ls -la /root/autodl-tmp/datapath/datasets/Flickr30k-CN/'

# æ£€æŸ¥æ‰€æœ‰æ¨¡å‹
ssh seetacloud-v800 'ls -la /root/autodl-tmp/datapath/experiments/'

# æ£€æŸ¥ç‰¹å¾æ–‡ä»¶ï¼ˆåœ¨è¯„ä¼°åï¼‰
ssh seetacloud-v800 'ls -la /root/autodl-tmp/datapath/datasets/Flickr30k-CN/*.jsonl'
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [Chinese-CLIPå®˜æ–¹æ–‡æ¡£](https://github.com/OFA-Sys/Chinese-CLIP)
- [MUGEæ£€ç´¢è¯„ä¼°Notebook](https://clip-cn-beijing.oss-cn-beijing.aliyuncs.com/others/Chinese-CLIP-on-MUGE-Retrieval.ipynb)
- Chinese-CLIPé¢„æµ‹åŠè¯„ä¼°æ–‡æ¡£

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒChinese-CLIPå®˜æ–¹æ–‡æ¡£æˆ–æissueè®¨è®ºã€‚ 